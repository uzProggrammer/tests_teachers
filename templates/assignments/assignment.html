{% extends 'assignments/base.html' %}

{% block title %}{{assignment.title|safe}}{% endblock title %}

{% block breadcrumb %}
    <li class="breadcrumb-item"><a href="/">Bosh sahifa</a></li>
    <li class="breadcrumb-item"><a href="/assignments/">Topshiriqlar</a></li>
    <li class="breadcrumb-item active" aria-current="page">{{assignment.title|title}}</li>
{% endblock breadcrumb %}

{% block content %}
    <style>
        .modal-body{
            max-height:400px;
            border-radius:10px;
            overflow-y: scroll;
        }
    </style>
    <div class="card bg-dark text-white">
        <div class="card-header p-4">
            <h1>{{assignment.title|safe}}</h1>{% if user.is_staff or user.is_teacher %} <a href="{% url 'assignment_edit' assignment.id %}" class="btn btn-primary m-2"> Tahrirlash</a>{% endif %}
        </div>
        <div class="card-body">
            {{assignment.info|safe}}
        </div>
        <div class="card-footer p-3">
            {{assignment.qachongacha|date:'d.m.Y | H.i'}} gacha
        </div>
    </div>
    {% if assignment.student != user and assignment.sinf != user.sinf %}
    <div class="card bg-dark text-white my-3">
        <div class="card-header p-3">
            <h3>Javoblar</h3>
        </div>
        <div class="card-body">
            <div class="accordion bg-dark text-white" id="answerca">
            {% for ass in answerca %}
              <div class="accordion-item bg-dark text-white">
                <h2 class="accordion-header bg-dark text-white" id="headingOne">
                  <button class="accordion-button bg-dark text-white" type="button" data-bs-toggle="collapse" data-bs-target="#answer{{ass.id}}" aria-expanded="true" aria-controls="collapseOne">
                      {{ass.student.username|title}}
                  </button>
                </h2>
                <div id="answer{{ass.id}}" class="accordion-collapse collapse bg-dark text-white" aria-labelledby="headingOne" data-bs-parent="#answerca">
                  <div class="accordion-body">
                    {{ass.answer|safe}}
                      <div class="text-end">
                          <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModal{{ass.id}}">Izohlar</button>
                          <a href="{% url 'add_answer_like' ass.id %}" class="btn btn-{% if user not in ass.likes.all %}outline-{% endif %}danger"><i class="bx bx-heart" style="font-size:20px;"></i> {{ass.likes.count}}</a>
                      </div>
                      {%  if user == assignment.author and not ass.student_answer_ball.exists or user.is_teacher or user.is_staff %}
                      <div class="accordion my-3 bg-dark text-white" id="accordionExample">
                          <div class="accordion-item bg-dark text-white">
                            <h2 class="accordion-header">
                              <button class="accordion-button bg-dark text-white" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                                Ball berish
                              </button>
                            </h2>
                            <div id="collapseOne" class="accordion-collapse text-right collapse" data-bs-parent="#accordionExample">
                              <div class="accordion-body">
                                    <form method="post">
                                        {% csrf_token %}<input type="hidden" value="{{ass.id}}" name="student_answer_id">
                                        <div class="m-3">
                                            <label class="form-label">Ball</label>
                                            <input type="number" required step="0.00001" name="ball" class="form-control bg-dark text-white">
                                            <div class="form-text text-white">Bergan balingiz</div>
                                        </div>
                                        <div class="m-3">
                                            <label class="form-label">Xatolar yoki izoh</label>
                                            <textarea name="xatolar" class="for-tiny"></textarea>
                                            <div class="form-text text-white">Siz o'quvchini ishiga ozroq izox berib o'ting</div>
                                        </div>
                                        <div class="m-3">
                                            <button type="submit" class="btn btn-outline-primary">Saqlash</button>
                                        </div>
                                    </form>
                              </div>
                            </div>
                          </div>

                        </div>
                      {% else %}
                      <div class="accordion my-3 bg-dark text-white" id="accordionExample1">
                          {% for ass_ball in ass.student_answer_ball.all %}
                              <div class="accordion-item bg-dark text-white">
                                <h2 class="accordion-header">
                                  <button class="accordion-button bg-dark text-white" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne1" aria-expanded="true" aria-controls="collapseOne1">
                                    O'quvchi olgan ball - {{ass_ball.ball}} <i>b</i>
                                  </button>
                                </h2>
                                <div id="collapseOne1" class="accordion-collapse text-right collapse" data-bs-parent="#accordionExample1">
                                  <div class="accordion-body">
                                      {{ass_ball.xatolar_va_kamchiliklar|safe}}
                                  </div>
                                </div>
                              </div>
                          {% endfor %}

                        </div>
                      {% endif %}
                      <div class="modal" id="exampleModal{{ass.id}}" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                          <div class="modal-dialog modal-lg bg-dark text-white">
                            <div class="modal-content bg-dark text-white">
                              <div class="modal-header">
                                <h1 class="modal-title fs-5" id="exampleModalLabel">{{ass.student.username|title}}ning javobi haqida fikrlar</h1>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                              </div>
                              <div class="modal-body">
                                <p class="text-info">Barchasi: {{ass.student_answer_comments.count}}ta</p>
                                  {% for comment in ass.student_answer_comments.all %}
                                    <div class="card p-3 bg-dark text-white">

                                    <div class="d-flex justify-content-between align-items-center">

                                  <div class="user d-flex flex-row align-items-center">

                                    <img src="{% if comment.user.is_teacher %}https://icon-library.com/images/teacher-icon-png/teacher-icon-png-17.jpg{% else %}https://upload.wikimedia.org/wikipedia/commons/thumb/f/f3/Student_%28example%29.svg/444px-Student_%28example%29.svg.png?20180722153736{% endif %}" width="30" class="user-img rounded-circle m-2">
                                    <span><a href="{% url 'profile' comment.user.username %}" class="font-weight-bold text-primary">{{comment.user.username|title}}</a> <small class="font-weight-bold">{{comment.body|safe}}</small></span>

                                  </div>


                                  <small>{{comment.date_created|date:"d.m.Y | H.i"}}</small>

                                  </div>


                                  <div class="action d-flex justify-content-between mt-2 align-items-center">

                                    <div class="reply px-4" style="opacity:0;">
                                        <small>Remove</small>
                                        <span class="dots"></span>
                                        <small>Reply</small>
                                        <span class="dots"></span>
                                        <small>Translate</small>
                                    </div>
                                    <div class="icons align-items-center">
                                        <a style="background:transparent;outline:none;border:none;" id="comment_like_button" href="{% url 'add_comment_like' comment.id %}"><i id="like_com{{comment.id}}" class="fa fa-heart {% if user in comment.likes.all %}text-danger{% else %}text-white{% endif %} comment_like"></i></a> <span id="like_count{{comment.id}}">{{comment.likes.count}}</span>
                                    </div>
                                  </div>
                                </div>
                                  {% endfor %}
                              </div><hr>
                              <div class="">
                                <form method="post">
                                    {% csrf_token %}
                                    <input type="hidden" value="{{ass.id}}" name="student_answer">
                                    <textarea placeholder="Shu yerga izohingingizni yozing..." name="comment_body" required class="emojiarea-editor outline-none scrollbar bg-dark text-white"></textarea>
                                    <button class="btn btn-sm btn-send shadow-none fw-bold text-info" type="submit">Yuborish</button>
                                </form>
                              </div>
                            </div>
                          </div>
                        </div>
                  </div>
                </div>
              </div>

            {% endfor %}
            </div>
        </div>
    </div>
    {% elif user.username in student_answers1 %}
    <div class="card bg-dark text-white my-3">
        <div class="card-header p-3">
            <h3>Javoblar</h3>
        </div>
        <div class="card-body">
            <div class="accordion bg-dark text-white" id="answerca">
            {% for ass in answerca %}
              <div class="accordion-item bg-dark text-white">
                <h2 class="accordion-header bg-dark text-white" id="headingOne">
                  <button class="accordion-button bg-dark text-white" type="button" data-bs-toggle="collapse" data-bs-target="#answer{{ass.id}}" aria-expanded="true" aria-controls="collapseOne">
                      {{ass.student.username|title}}
                  </button>
                </h2>
                <div id="answer{{ass.id}}" class="accordion-collapse collapse bg-dark text-white" aria-labelledby="headingOne" data-bs-parent="#answerca">
                  <div class="accordion-body">
                    {{ass.answer|safe}}
                      <div class="text-end">
                          <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModal{{ass.id}}">Izohlar</button>
                          <a href="{% url 'add_answer_like' ass.id %}" class="btn btn-{% if user not in ass.likes.all %}outline-{% endif %}danger"><i class="bx bx-heart" style="font-size:20px;"></i> {{ass.likes.count}}</a>
                      </div>
                      {%  if user == assignment.author and not ass.student_answer_ball.exists %}
                      <div class="accordion my-3 bg-dark text-white" id="accordionExample">
                          <div class="accordion-item bg-dark text-white">
                            <h2 class="accordion-header">
                              <button class="accordion-button bg-dark text-white" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                                Ball berish
                              </button>
                            </h2>
                            <div id="collapseOne" class="accordion-collapse text-right collapse" data-bs-parent="#accordionExample">
                              <div class="accordion-body">
                                    <form method="post">
                                        {% csrf_token %}<input type="hidden" value="{{ass.id}}" name="student_answer_id">
                                        <div class="m-3">
                                            <label class="form-label">Ball</label>
                                            <input type="number" required step="0.00001" name="ball" class="form-control bg-dark text-white">
                                            <div class="form-text text-white">Bergan balingiz</div>
                                        </div>
                                        <div class="m-3">
                                            <label class="form-label">Xatolar yoki izoh</label>
                                            <textarea name="xatolar" class="for-tiny"></textarea>
                                            <div class="form-text text-white">Siz o'quvchini ishiga ozroq izox berib o'ting</div>
                                        </div>
                                        <div class="m-3">
                                            <button type="submit" class="btn btn-outline-primary">Saqlash</button>
                                        </div>
                                    </form>
                              </div>
                            </div>
                          </div>

                        </div>
                      {% else %}
                      <div class="accordion my-3 bg-dark text-white" id="accordionExample1">
                          {% for ass_ball in ass.student_answer_ball.all %}
                              <div class="accordion-item bg-dark text-white">
                                <h2 class="accordion-header">
                                  <button class="accordion-button bg-dark text-white" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne1" aria-expanded="true" aria-controls="collapseOne1">
                                    O'quvchi olgan ball - {{ass_ball.ball}} <i>b</i>
                                  </button>
                                </h2>
                                <div id="collapseOne1" class="accordion-collapse text-right collapse" data-bs-parent="#accordionExample1">
                                  <div class="accordion-body">
                                      {{ass_ball.xatolar_va_kamchiliklar|safe}}
                                  </div>
                                </div>
                              </div>
                          {% endfor %}

                        </div>
                      {% endif %}
                      <div class="modal" id="exampleModal{{ass.id}}" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                          <div class="modal-dialog modal-lg bg-dark text-white">
                            <div class="modal-content bg-dark text-white">
                              <div class="modal-header">
                                <h1 class="modal-title fs-5" id="exampleModalLabel">{{ass.student.username|title}}ning javobi haqida fikrlar</h1>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                              </div>
                              <div class="modal-body">
                                <p class="text-info">Barchasi: {{ass.student_answer_comments.count}}ta</p>
                                  {% for comment in ass.student_answer_comments.all %}
                                    <div class="card p-3 bg-dark text-white">

                                    <div class="d-flex justify-content-between align-items-center">

                                  <div class="user d-flex flex-row align-items-center">

                                    <img src="{% if comment.user.is_teacher %}https://icon-library.com/images/teacher-icon-png/teacher-icon-png-17.jpg{% else %}https://upload.wikimedia.org/wikipedia/commons/thumb/f/f3/Student_%28example%29.svg/444px-Student_%28example%29.svg.png?20180722153736{% endif %}" width="30" class="user-img rounded-circle m-2">
                                    <span><a href="{% url 'profile' comment.user.username %}" class="font-weight-bold text-primary">{{comment.user.username|title}}</a> <small class="font-weight-bold">{{comment.body|safe}}</small></span>

                                  </div>


                                  <small>{{comment.date_created|date:"d.m.Y | H.i"}}</small>

                                  </div>


                                  <div class="action d-flex justify-content-between mt-2 align-items-center">

                                    <div class="reply px-4" style="opacity:0;">
                                        <small>Remove</small>
                                        <span class="dots"></span>
                                        <small>Reply</small>
                                        <span class="dots"></span>
                                        <small>Translate</small>
                                    </div>
                                    <div class="icons align-items-center">
                                        <a style="background:transparent;outline:none;border:none;" id="comment_like_button" href="{% url 'add_comment_like' comment.id %}"><i id="like_com{{comment.id}}" class="fa fa-heart {% if user in comment.likes.all %}text-danger{% else %}text-white{% endif %} comment_like"></i></a> <span id="like_count{{comment.id}}">{{comment.likes.count}}</span>
                                    </div>
                                  </div>
                                </div>
                                  {% endfor %}
                              </div><hr>
                              <div class="">
                                <form method="post">
                                    {% csrf_token %}
                                    <input type="hidden" value="{{ass.id}}" name="student_answer">
                                    <textarea placeholder="Shu yerga izohingingizni yozing..." name="comment_body" required class="emojiarea-editor outline-none scrollbar bg-dark text-white"></textarea>
                                    <button class="btn btn-sm btn-send shadow-none fw-bold text-info" type="submit">Yuborish</button>
                                </form>
                              </div>
                            </div>
                          </div>
                        </div>
                  </div>
                </div>
              </div>

            {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}
    {% if user.username not in student_answers1 and tugadi == False %}
        {% if assignment.student == user %}
            <div class="card bg-dark text-white my-3">
                <div class="p-3 card-header">
                    <h3>Javobini yuborish</h3>
                </div>
                <div class="card-body">
                    <form method="post">{% csrf_token %}
                        <div class="m-3">
                            <label for="answer" class="form-label">Sizning javobingiz</label>
                            <textarea class="form-control bg-dark text-white for-tiny" id="answer" name="answer"></textarea>
                        </div>
                        <div class="m-3">
                            <label for="helper_users" class="form-label">Yordam bergan foydalanuvchilar</label>
                            <select id="helper_users" name="helper-user" class="form-control bg-dark text-white" multiple multiselect-hide-x="true" multiselect-search="true">
                                {% for user1 in users %}
                                <option value="{{user1.id}}">{{user1.username}}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="m-3">
                            <button class="btn btn-outline-primary" type="submit">Yuborish</button>
                        </div>
                    </form>
                </div>
            </div>
        <script>

              var style = document.createElement('style');
            style.setAttribute("id","multiselect_dropdown_styles");
            style.innerHTML = `
            .multiselect-dropdown{
              display: inline-block;
              padding: 2px 5px 0px 5px;
              border-radius: 4px;
              border: solid 1px #ced4da;
              background-color: white;
              position: relative;
              background-color: #1e1d1f;
              background-repeat: no-repeat;
              background-position: right .75rem center;
              background-size: 16px 12px;
            }
            .multiselect-dropdown span.optext, .multiselect-dropdown span.placeholder{
              margin-right:0.5em;
              margin-bottom:2px;
              padding:1px 0;
              border-radius: 4px;
              display:inline-block;
            }
            .multiselect-dropdown span.optext{
              background-color:lightgray;
              padding:1px 0.75em;
              color: black;
            }
            .multiselect-dropdown span.optext .optdel {
              float: right;
              margin: 0 -6px 1px 5px;
              font-size: 0.7em;
              margin-top: 2px;
              cursor: pointer;
              color: black;
            }
            .multiselect-dropdown span.optext .optdel:hover { color: #c66;}
            .multiselect-dropdown span.placeholder{
              color:#ced4da;
            }
            .multiselect-dropdown-list-wrapper{
              box-shadow: gray 0 3px 8px;
              z-index: 100;
              padding:2px;
              border-radius: 4px;
              border: solid 1px #ced4da;
              display: none;
              margin: -1px;
              position: absolute;
              top:0;
              left: 0;
              right: 0;
            }
            .multiselect-dropdown-list-wrapper .multiselect-dropdown-search{
              margin-bottom:5px;
            }
            .multiselect-dropdown-list{
              padding:2px;
              height: 15rem;
              overflow-y:auto;
              overflow-x: hidden;
            }
            .multiselect-dropdown-list::-webkit-scrollbar {
              width: 6px;
            }
            .multiselect-dropdown-list::-webkit-scrollbar-thumb {
              background-color: #bec4ca;
              border-radius:3px;
            }

            .multiselect-dropdown-list div{
              padding: 5px;
            }
            .multiselect-dropdown-list input{
              height: 1.15em;
              width: 1.15em;
              margin-right: 0.35em;
            }
            .multiselect-dropdown-list div.checked{
            }
            .multiselect-dropdown-list div:hover{
              background-color: #ced4da;
            }
            .multiselect-dropdown span.maxselected {width:100%;}
            .multiselect-dropdown-all-selector {border-bottom:solid 1px #999;}
            `;
            document.head.appendChild(style);

            function MultiselectDropdown(options){
              var config={
                search:true,
                height:'15rem',
                placeholder:'select',
                txtSelected:'selected',
                txtAll:'All',
                txtRemove: 'Remove',
                txtSearch:'search',
                ...options
              };
              function newEl(tag,attrs){
                var e=document.createElement(tag);
                if(attrs!==undefined) Object.keys(attrs).forEach(k=>{
                  if(k==='class') { Array.isArray(attrs[k]) ? attrs[k].forEach(o=>o!==''?e.classList.add(o):0) : (attrs[k]!==''?e.classList.add(attrs[k]):0)}
                  else if(k==='style'){
                    Object.keys(attrs[k]).forEach(ks=>{
                      e.style[ks]=attrs[k][ks];
                    });
                   }
                  else if(k==='text'){attrs[k]===''?e.innerHTML='&nbsp;':e.innerText=attrs[k]}
                  else e[k]=attrs[k];
                });
                return e;
              }


              document.querySelectorAll("select[multiple]").forEach((el,k)=>{

                var div=newEl('div',{class:'multiselect-dropdown',style:{width:config.style?.width??el.clientWidth+'px',padding:config.style?.padding??''}});
                el.style.display='none';
                el.parentNode.insertBefore(div,el.nextSibling);
                var listWrap=newEl('div',{class:'multiselect-dropdown-list-wrapper'});
                var list=newEl('div',{class:'multiselect-dropdown-list',style:{height:config.height}});
                var search=newEl('input',{class:['multiselect-dropdown-search'].concat([config.searchInput?.class??'form-control']),style:{width:'100%',display:el.attributes['multiselect-search']?.value==='true'?'block':'none'},placeholder:config.txtSearch});
                listWrap.appendChild(search);
                div.appendChild(listWrap);
                listWrap.appendChild(list);

                el.loadOptions=()=>{
                  list.innerHTML='';

                  if(el.attributes['multiselect-select-all']?.value=='true'){
                    var op=newEl('div',{class:'multiselect-dropdown-all-selector'})
                    var ic=newEl('input',{type:'checkbox'});
                    op.appendChild(ic);
                    op.appendChild(newEl('label',{text:config.txtAll}));

                    op.addEventListener('click',()=>{
                      op.classList.toggle('checked');
                      op.querySelector("input").checked=!op.querySelector("input").checked;

                      var ch=op.querySelector("input").checked;
                      list.querySelectorAll(":scope > div:not(.multiselect-dropdown-all-selector)")
                        .forEach(i=>{if(i.style.display!=='none'){i.querySelector("input").checked=ch; i.optEl.selected=ch}});

                      el.dispatchEvent(new Event('change'));
                    });
                    ic.addEventListener('click',(ev)=>{
                      ic.checked=!ic.checked;
                    });
                    el.addEventListener('change', (ev)=>{
                      let itms=Array.from(list.querySelectorAll(":scope > div:not(.multiselect-dropdown-all-selector)")).filter(e=>e.style.display!=='none')
                      let existsNotSelected=itms.find(i=>!i.querySelector("input").checked);
                      if(ic.checked && existsNotSelected) ic.checked=false;
                      else if(ic.checked==false && existsNotSelected===undefined) ic.checked=true;
                    });

                    list.appendChild(op);
                  }

                  Array.from(el.options).map(o=>{
                    var op=newEl('div',{class:o.selected?'checked':'',optEl:o})
                    var ic=newEl('input',{type:'checkbox',checked:o.selected});
                    op.appendChild(ic);
                    op.appendChild(newEl('label',{text:o.text}));

                    op.addEventListener('click',()=>{
                      op.classList.toggle('checked');
                      op.querySelector("input").checked=!op.querySelector("input").checked;
                      op.optEl.selected=!!!op.optEl.selected;
                      el.dispatchEvent(new Event('change'));
                    });
                    ic.addEventListener('click',(ev)=>{
                      ic.checked=!ic.checked;
                    });
                    o.listitemEl=op;
                    list.appendChild(op);
                  });
                  div.listEl=listWrap;

                  div.refresh=()=>{
                    div.querySelectorAll('span.optext, span.placeholder').forEach(t=>div.removeChild(t));
                    var sels=Array.from(el.selectedOptions);
                    if(sels.length>(el.attributes['multiselect-max-items']?.value??5)){
                      div.appendChild(newEl('span',{class:['optext','maxselected'],text:sels.length+' '+config.txtSelected}));
                    }
                    else{
                      sels.map(x=>{
                        var c=newEl('span',{class:'optext',text:x.text, srcOption: x});
                        if((el.attributes['multiselect-hide-x']?.value !== 'true'))
                          c.appendChild(newEl('span',{class:'optdel',text:'ðŸ—™',title:config.txtRemove, onclick:(ev)=>{c.srcOption.listitemEl.dispatchEvent(new Event('click'));div.refresh();ev.stopPropagation();}}));

                        div.appendChild(c);
                      });
                    }
                    if(0==el.selectedOptions.length) div.appendChild(newEl('span',{class:'placeholder',text:el.attributes['placeholder']?.value??config.placeholder}));
                  };
                  div.refresh();
                }
                el.loadOptions();

                search.addEventListener('input',()=>{
                  list.querySelectorAll(":scope div:not(.multiselect-dropdown-all-selector)").forEach(d=>{
                    var txt=d.querySelector("label").innerText.toUpperCase();
                    d.style.display=txt.includes(search.value.toUpperCase())?'block':'none';
                  });
                });

                div.addEventListener('click',()=>{
                  div.listEl.style.display='block';
                  search.focus();
                  search.select();
                });

                document.addEventListener('click', function(event) {
                  if (!div.contains(event.target)) {
                    listWrap.style.display='none';
                    div.refresh();
                  }
                });
              });
            }

            window.addEventListener('load',()=>{
              MultiselectDropdown(window.MultiselectDropdownOptions);
            });
        </script>
        {% elif assignment.sinf == user.sinf %}
            <div class="card bg-dark text-white my-3">
                <div class="p-3 card-header">
                    <h3>Javobini yuborish</h3>
                </div>
                <div class="card-body">
                    <form method="post">{% csrf_token %}
                        <div class="m-3">
                            <label for="answer" class="form-label">Sizning javobingiz</label>
                            <textarea class="form-control bg-dark text-white for-tiny" id="answer" name="answer"></textarea>
                        </div>
                        <div class="m-3">
                            <label for="helper_users" class="form-label">Yordam bergan foydalanuvchilar</label>
                            <select id="helper_users" name="helper_users" class="form-control bg-dark text-white" multiple multiselect-hide-x="true" multiselect-search="true">
                                {% for user1 in users %}
                                <option value="{{user1.id}}">{{user1.username}}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="m-3">
                            <button class="btn btn-outline-primary" type="submit">Yuborish</button>
                        </div>
                    </form>
                </div>
            </div>
        <script>

              var style = document.createElement('style');
            style.setAttribute("id","multiselect_dropdown_styles");
            style.innerHTML = `
            .multiselect-dropdown{
              display: inline-block;
              padding: 2px 5px 0px 5px;
              border-radius: 4px;
              border: solid 1px #ced4da;
              background-color: white;
              position: relative;
              background-color: #1e1d1f;
              background-repeat: no-repeat;
              background-position: right .75rem center;
              background-size: 16px 12px;
            }
            .multiselect-dropdown span.optext, .multiselect-dropdown span.placeholder{
              margin-right:0.5em;
              margin-bottom:2px;
              padding:1px 0;
              border-radius: 4px;
              display:inline-block;
            }
            .multiselect-dropdown span.optext{
              background-color:lightgray;
              padding:1px 0.75em;
              color: black;
            }
            .multiselect-dropdown span.optext .optdel {
              float: right;
              margin: 0 -6px 1px 5px;
              font-size: 0.7em;
              margin-top: 2px;
              cursor: pointer;
              color: black;
            }
            .multiselect-dropdown span.optext .optdel:hover { color: #c66;}
            .multiselect-dropdown span.placeholder{
              color:#ced4da;
            }
            .multiselect-dropdown-list-wrapper{
              box-shadow: gray 0 3px 8px;
              z-index: 100;
              padding:2px;
              border-radius: 4px;
              border: solid 1px #ced4da;
              display: none;
              margin: -1px;
              position: absolute;
              top:0;
              left: 0;
              right: 0;
            }
            .multiselect-dropdown-list-wrapper .multiselect-dropdown-search{
              margin-bottom:5px;
            }
            .multiselect-dropdown-list{
              padding:2px;
              height: 15rem;
              overflow-y:auto;
              overflow-x: hidden;
            }
            .multiselect-dropdown-list::-webkit-scrollbar {
              width: 6px;
            }
            .multiselect-dropdown-list::-webkit-scrollbar-thumb {
              background-color: #bec4ca;
              border-radius:3px;
            }

            .multiselect-dropdown-list div{
              padding: 5px;
            }
            .multiselect-dropdown-list input{
              height: 1.15em;
              width: 1.15em;
              margin-right: 0.35em;
            }
            .multiselect-dropdown-list div.checked{
            }
            .multiselect-dropdown-list div:hover{
              background-color: #ced4da;
            }
            .multiselect-dropdown span.maxselected {width:100%;}
            .multiselect-dropdown-all-selector {border-bottom:solid 1px #999;}
            `;
            document.head.appendChild(style);

            function MultiselectDropdown(options){
              var config={
                search:true,
                height:'15rem',
                placeholder:'select',
                txtSelected:'selected',
                txtAll:'All',
                txtRemove: 'Remove',
                txtSearch:'search',
                ...options
              };
              function newEl(tag,attrs){
                var e=document.createElement(tag);
                if(attrs!==undefined) Object.keys(attrs).forEach(k=>{
                  if(k==='class') { Array.isArray(attrs[k]) ? attrs[k].forEach(o=>o!==''?e.classList.add(o):0) : (attrs[k]!==''?e.classList.add(attrs[k]):0)}
                  else if(k==='style'){
                    Object.keys(attrs[k]).forEach(ks=>{
                      e.style[ks]=attrs[k][ks];
                    });
                   }
                  else if(k==='text'){attrs[k]===''?e.innerHTML='&nbsp;':e.innerText=attrs[k]}
                  else e[k]=attrs[k];
                });
                return e;
              }


              document.querySelectorAll("select[multiple]").forEach((el,k)=>{

                var div=newEl('div',{class:'multiselect-dropdown',style:{width:config.style?.width??el.clientWidth+'px',padding:config.style?.padding??''}});
                el.style.display='none';
                el.parentNode.insertBefore(div,el.nextSibling);
                var listWrap=newEl('div',{class:'multiselect-dropdown-list-wrapper'});
                var list=newEl('div',{class:'multiselect-dropdown-list',style:{height:config.height}});
                var search=newEl('input',{class:['multiselect-dropdown-search'].concat([config.searchInput?.class??'form-control']),style:{width:'100%',display:el.attributes['multiselect-search']?.value==='true'?'block':'none'},placeholder:config.txtSearch});
                listWrap.appendChild(search);
                div.appendChild(listWrap);
                listWrap.appendChild(list);

                el.loadOptions=()=>{
                  list.innerHTML='';

                  if(el.attributes['multiselect-select-all']?.value=='true'){
                    var op=newEl('div',{class:'multiselect-dropdown-all-selector'})
                    var ic=newEl('input',{type:'checkbox'});
                    op.appendChild(ic);
                    op.appendChild(newEl('label',{text:config.txtAll}));

                    op.addEventListener('click',()=>{
                      op.classList.toggle('checked');
                      op.querySelector("input").checked=!op.querySelector("input").checked;

                      var ch=op.querySelector("input").checked;
                      list.querySelectorAll(":scope > div:not(.multiselect-dropdown-all-selector)")
                        .forEach(i=>{if(i.style.display!=='none'){i.querySelector("input").checked=ch; i.optEl.selected=ch}});

                      el.dispatchEvent(new Event('change'));
                    });
                    ic.addEventListener('click',(ev)=>{
                      ic.checked=!ic.checked;
                    });
                    el.addEventListener('change', (ev)=>{
                      let itms=Array.from(list.querySelectorAll(":scope > div:not(.multiselect-dropdown-all-selector)")).filter(e=>e.style.display!=='none')
                      let existsNotSelected=itms.find(i=>!i.querySelector("input").checked);
                      if(ic.checked && existsNotSelected) ic.checked=false;
                      else if(ic.checked==false && existsNotSelected===undefined) ic.checked=true;
                    });

                    list.appendChild(op);
                  }

                  Array.from(el.options).map(o=>{
                    var op=newEl('div',{class:o.selected?'checked':'',optEl:o})
                    var ic=newEl('input',{type:'checkbox',checked:o.selected});
                    op.appendChild(ic);
                    op.appendChild(newEl('label',{text:o.text}));

                    op.addEventListener('click',()=>{
                      op.classList.toggle('checked');
                      op.querySelector("input").checked=!op.querySelector("input").checked;
                      op.optEl.selected=!!!op.optEl.selected;
                      el.dispatchEvent(new Event('change'));
                    });
                    ic.addEventListener('click',(ev)=>{
                      ic.checked=!ic.checked;
                    });
                    o.listitemEl=op;
                    list.appendChild(op);
                  });
                  div.listEl=listWrap;

                  div.refresh=()=>{
                    div.querySelectorAll('span.optext, span.placeholder').forEach(t=>div.removeChild(t));
                    var sels=Array.from(el.selectedOptions);
                    if(sels.length>(el.attributes['multiselect-max-items']?.value??5)){
                      div.appendChild(newEl('span',{class:['optext','maxselected'],text:sels.length+' '+config.txtSelected}));
                    }
                    else{
                      sels.map(x=>{
                        var c=newEl('span',{class:'optext',text:x.text, srcOption: x});
                        if((el.attributes['multiselect-hide-x']?.value !== 'true'))
                          c.appendChild(newEl('span',{class:'optdel',text:'ðŸ—™',title:config.txtRemove, onclick:(ev)=>{c.srcOption.listitemEl.dispatchEvent(new Event('click'));div.refresh();ev.stopPropagation();}}));

                        div.appendChild(c);
                      });
                    }
                    if(0==el.selectedOptions.length) div.appendChild(newEl('span',{class:'placeholder',text:el.attributes['placeholder']?.value??config.placeholder}));
                  };
                  div.refresh();
                }
                el.loadOptions();

                search.addEventListener('input',()=>{
                  list.querySelectorAll(":scope div:not(.multiselect-dropdown-all-selector)").forEach(d=>{
                    var txt=d.querySelector("label").innerText.toUpperCase();
                    d.style.display=txt.includes(search.value.toUpperCase())?'block':'none';
                  });
                });

                div.addEventListener('click',()=>{
                  div.listEl.style.display='block';
                  search.focus();
                  search.select();
                });

                document.addEventListener('click', function(event) {
                  if (!div.contains(event.target)) {
                    listWrap.style.display='none';
                    div.refresh();
                  }
                });
              });
            }

            window.addEventListener('load',()=>{
              MultiselectDropdown(window.MultiselectDropdownOptions);
            });

        </script>
        {% endif %}
    {% endif %}
{% endblock content %}

{% block js1 %}
<script>
    tinymce.init({
        themes: "modern",
        skin: "oxide-dark",
        content_css: "dark",
        selector: 'textarea.for-tiny',
        plugins: 'anchor autolink charmap codesample emoticons image link lists media searchreplace table visualblocks wordcount',
        toolbar: 'undo redo | fontsize | bold italic underline strikethrough | link image media table | align lineheight | numlist bullist indent outdent | emoticons charmap',
    });
</script>
{% endblock %}